# Coffee Payments Server — Документация проекта

## Краткое описание бизнес-задачи

Проект — это **MVP версия** сервера для обработки платежей в системе кофейных автоматов. Он предоставляет API для управления устройствами (кофемашинами), обработки заказов напитков и интеграции с платежными системами (ЮKassa, ТБанк). Сервис позволяет мерчантам (владельцам кофемашин) принимать платежи, отслеживать статус заказов. Система предназначена для автоматизации оплаты напитков в сетях кофейных автоматов.

## Используемые технологии

### Языки программирования
- **Python 3.x** — основной язык разработки бэкенда

### Фреймворки и библиотеки
- **Django 5.1.4** — веб-фреймворк для создания REST API и обработки HTTP-запросов
- **Django REST Framework 3.15.2** — расширение для более удобной работы с REST API
- **Requests 2.32.3** — библиотека для выполнения HTTP-запросов к внешним API
- **Paho MQTT 2.1.0** — клиент MQTT для взаимодействия с IoT-устройствами
- **YooKassa 3.5.0** — SDK для интеграции с платежной системой ЮKassa
- **Psycopg2 2.9.10** — драйвер для подключения к PostgreSQL

### База данных
- **PostgreSQL** — реляционная СУБД для хранения данных о мерчантах, устройствах, заказах и платежах

### Инструменты сборки, тестирования и деплоя
- **Docker** — контейнеризация приложения
- **Docker Compose** — орхестрация контейнеров для локального развертывания
- **pip** — менеджер пакетов Python
- **Django ORM** — встроенная система управления моделями данных

## Архитектура проекта

### Архитектурный паттерн
Проект использует классическую **MVC архитектуру** (Model-View-Controller) с элементами REST API:

- **Models** — определяют структуру данных в БД (Merchant, Device, Order, Payment, Receipt и т.д.)
- **Views** — обрабатывают HTTP-запросы и возвращают ответы (JSON или HTML)
- **Controllers** — встроены в Views, управляют бизнес-логикой
- **Services** — отдельные модули для работы с внешними API (Tmetr, YooKassa, QR-коды)

### Основные компоненты системы

#### 1. **API слой (Views)**
- `process_payment_flow()` — основная функция обработки платежного потока после сканирования QR-кода, включает валидацию устройства, создание заказа и маршрутизацию по платежным сценариям
- `initiate_payment()` — инициация платежа после подтверждения заказа пользователем
- `yookassa_payment_result_webhook()` — обработка webhook'ов от платежных систем
- Управление заказами и статусами

#### 2. **Сервисный слой (Services)**
- `payment_scenario_service.py` — управление сценариями оплаты и маршрутизация платежей
- `yookassa_service.py` — интеграция с платежной системой ЮKassa
- `t_bank_service.py` — интеграция с платежной системой TBank
- `tmetr_service.py` — интеграция с API Tmetr для управления кофемашинами
- `qr_code_service.py` — валидация устройств и мерчантов
- `telemetry_service.py` — получение информации о напитках с устройств

#### 3. **Слой данных (Models)**
- `Merchant` — информация о владельцах кофемашин
- `Device` — данные о кофемашинах (статус, локация, привязка к мерчанту, сценарий оплаты, логотип, информация для клиентов)
- `MerchantCredentials` — учетные данные мерчантов для различных платежных сценариев (Yookassa, TBank, Custom)
- `Drink` — каталог напитков с ценами
- `Order` — заказы напитков с детализированной статусной моделью (7 статусов) и механизмом протухания
- `Payment` — информация о платежах
- `Receipt` — чеки для отправки пользователям
- `TBankPayment` — платежи через Tbank

#### 4. **Утилиты**
- `logging.py` — централизованное логирование всех операций
- `user_messages.py` — централизованное хранение пользовательских сообщений об ошибках

### Взаимодействие компонентов

```
Клиент (QR-код с кофемашины)
        ↓
GET /v1/pay → process_payment_flow()
        ↓
    ┌───────────────────────┐
    │  Валидация параметров │
    │  + Device + Merchant  │
    │  (QR Code Service)    │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │  Получение информации │
    │  о напитке            │
    │  (Tmetr Service)      │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │  Создание Order       │
    │  (status='created')   │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │  Определение Payment  │
    │  Scenario             │
    └───────────────────────┘
        ↓
    ┌─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
Yookassa/TBank                      Custom
    │                                     │
    ▼                                     ▼
show_order_info()              execute_custom_scenario()
    │                                     │
    ▼                                     │
initiate_payment()                       │
    │                                     │
    ▼                                     ▼
Payment Service (создание платежа)
    │
    ↓
   Redirect to Payment URL
        ↓
[Пользователь оплачивает]
        ↓
    Webhook от платежной системы
        ↓
    ┌───────────────────────┐
    │ Update Order Status   │
    │ (Models)              │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │ Tmetr Service         │
    │ (отправить команду    │
    │  приготовления)       │
    └───────────────────────┘
        ↓
    Кофемашина готовит напиток
```

## Основные файлы и директории

### Корневая директория
```
coffee_payment/                    # Корневая папка проекта
├── README.md                      # Основная документация проекта
├── requirements.txt               # Зависимости Python
├── manage.py                      # Управление Django проектом
├── docker-compose.yml             # Конфигурация для запуска в Docker
├── Dockerfile                     # Образ приложения
├── entrypoint.sh                  # Скрипт инициализации контейнера
└── run.sh                         # Скрипт для локального запуска
```

### Папка `coffee_payment/` — конфигурация Django
```
coffee_payment/
├── __init__.py                    # Инициализация пакета
├── settings.py                    # Основные настройки проекта (БД, приложения, API ключи)
├── urls.py                        # Маршруты приложения
├── asgi.py                        # ASGI конфигурация для async серверов
├── wsgi.py                        # WSGI конфигурация для WSGI серверов
└── __pycache__/                   # Кэш скомпилированного Python кода
```

### Папка `payments/` — основное приложение
```
payments/
├── __init__.py
├── admin.py                       # Регистрация моделей в Django Admin
├── apps.py                        # Конфигурация приложения
├── models.py                      # Модели данных (Merchant, Device, Order, Payment и т.д.)
├── tests.py                       # Тесты приложения
├── views.py                       # API endpoints и обработчики запросов
├── migrations/                    # Миграции базы данных
│   ├── __init__.py
│   ├── 0001_initial.py            # Начальная миграция
│   ├── 0002_...py                 # Последующие изменения схемы
│   └── ...
├── services/                      # Сервисы для работы с внешними API
│   ├── payment_scenario_service.py # Управление сценариями оплаты
│   ├── yookassa_service.py        # Интеграция с ЮKassa
│   ├── t_bank_service.py          # Интеграция с TBank
│   ├── tmetr_service.py           # Интеграция с Tmetr API
│   ├── qr_code_service.py         # Обработка QR-кодов
│   ├── telemetry_service.py       # Получение телеметрии с устройств
│   ├── mqtt_yaclient.py           # MQTT клиент для Yandex Cloud
│   ├── cm_mqtt.py                 # MQTT команды для кофемашин
│   └── __pycache__/
├── utils/                         # Вспомогательные утилиты
│   ├── logging.py                 # Централизованное логирование
│   └── __pycache__/
└── __pycache__/
```

### Папка `templates/` — HTML шаблоны
```
templates/
└── payments/
    ├── error_page.html            # Страница ошибки
    ├── receipt_data_form.html     # Форма для ввода данных чека
    └── order_info_screen.html     # Экран информации о заказе перед оплатой
```

### Папка `static/` — статические файлы
```
static/                           # CSS, JS, изображения (если требуется)
```

### Папка `docs/` — документация
```
docs/                             # Папка с документацией проекта
└── PROJECT.md                     # Этот файл
```

### Папка `logs/` — логи приложения
```
logs/                             # Логи выполнения приложения
```

## Основные потоки данных

### 1. Инициирование платежа (QR-код)
1. Клиент сканирует QR-код на кофемашине
2. Запрос попадает в `process_payment_flow()` через URL `/v1/pay`
3. Валидируются все обязательные параметры (deviceUuid, drinkNo, drinkName, size, uuid)
4. Проверяется существование Device и активность Merchant через функции `validate_device()` и `validate_merchant()` из qr_code_service
5. Получается информация о напитке из Tmetr API
6. Создается Order со статусом `created` и временем протухания (expires_at)
7. Определяется платежный сценарий для устройства (`device.payment_scenario`)
8. **Для Yookassa/TBank**: отображается экран информации о заказе с деталями напитка, ценой и кнопкой "Перейти к оплате"
9. **Для Custom**: выполняется прямой редирект на внешний URL через `PaymentScenarioService.execute_scenario()`

### 2. Обработка платежа (после подтверждения заказа)
1. Пользователь нажимает кнопку "Перейти к оплате" на экране информации
2. Вызывается `initiate_payment()` через POST-запрос
3. Проверяется, не протух ли заказ (expires_at)
4. Создается платеж через API платежной системы (Yookassa или TBank)
5. Статус Order меняется на `pending`
6. Пользователь редиректится на страницу оплаты платежной системы

### 3. Обработка результата платежа (Webhook)
1. YooKassa отправляет webhook при успешном платеже
2. `yookassa_payment_result_webhook()` проверяет, не протух ли заказ
3. Статус Order обновляется: `pending` → `paid` (при успехе) или `not_paid` (при отмене)
4. Отправляется команда на кофемашину через Tmetr API, статус меняется на `make_pending`
5. После приготовления статус меняется на `successful`
6. При критических ошибках статус меняется на `failed`

## Статусная модель заказов

Система использует детализированную статусную модель для отслеживания жизненного цикла заказа:

1. **created** — Заказ создан после валидации
2. **pending** — Платеж создан, ожидается оплата
3. **paid** — Оплата прошла успешно
4. **not_paid** — Оплата не прошла
5. **make_pending** — Команда на приготовление отправлена
6. **successful** — Заказ успешно завершен
7. **failed** — Заказ не может быть завершен (критическая ошибка)

### Механизм протухания заказов

Каждый заказ имеет поле `expires_at`, которое автоматически устанавливается при создании. Время протухания настраивается через параметр `ORDER_EXPIRATION_MINUTES` (по умолчанию 15 минут). Протухшие заказы не обрабатываются системой.

## Конфигурация сценариев оплаты

Система поддерживает гибкую настройку платежных сценариев для каждой кофемашины. Это позволяет использовать различных платежных провайдеров и интегрироваться с внешними системами оплаты.

### Доступные сценарии оплаты

Система поддерживает три типа платежных сценариев:

1. **Yookassa** — интеграция с платежной системой ЮKassa (по умолчанию)
2. **TBank** — интеграция с платежной системой TBank
3. **Custom** — перенаправление на внешнюю систему оплаты

Список доступных сценариев настраивается в `settings.py`:

```python
PAYMENT_SCENARIOS = ['Yookassa', 'TBank', 'Custom']
DEFAULT_PAYMENT_SCENARIO = 'Yookassa'
```

### Модель Device

Каждая кофемашина (Device) имеет поле `payment_scenario`, которое определяет, какой сценарий оплаты будет использоваться для этого устройства:

```python
class Device(models.Model):
    # ... другие поля ...
    payment_scenario = models.CharField(
        max_length=50,
        default='Yookassa',
        help_text='Payment scenario for this device'
    )
    logo_url = models.URLField(
        null=True, 
        blank=True,
        help_text='URL to merchant logo image displayed on order screen'
    )
    client_info = models.TextField(
        null=True,
        blank=True,
        help_text='Custom information displayed to customers on order screen'
    )
```

При создании нового устройства автоматически устанавливается сценарий по умолчанию (Yookassa). Сценарий можно изменить через Django Admin или API.

**Дополнительные поля для экрана информации о заказе:**
- `logo_url` — URL логотипа мерчанта, отображается на экране заказа
- `client_info` — произвольная информация для клиентов (например, контакты поддержки)

### Модель MerchantCredentials

Для каждого платежного сценария мерчант должен предоставить свои учетные данные. Они хранятся в модели `MerchantCredentials`:

```python
class MerchantCredentials(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    merchant = models.ForeignKey(Merchant, on_delete=models.CASCADE, related_name='credentials')
    scenario = models.CharField(max_length=50)
    credentials = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = ('merchant', 'scenario')
```

Учетные данные хранятся в формате JSON в поле `credentials`. Каждый мерчант может иметь учетные данные для нескольких сценариев.

### Структура учетных данных

#### Yookassa Credentials

```json
{
  "account_id": "1193510",
  "secret_key": "test_Ku1e9ZkX5OoTCm0k2m05Dg66XldJFHkER_9sw5LKE1E"
}
```

Поля:
- `account_id` — идентификатор магазина в ЮKassa
- `secret_key` — секретный ключ для API ЮKassa

#### TBank Credentials

```json
{
  "shop_id": "ShopID123",
  "secret_key": "SecretKey456",
  "success_url": "https://example.com/success",
  "fail_url": "https://example.com/fail"
}
```

Поля:
- `shop_id` — идентификатор магазина в TBank
- `secret_key` — секретный ключ для API TBank
- `success_url` — URL для перенаправления при успешной оплате
- `fail_url` — URL для перенаправления при неудачной оплате

#### Custom Credentials

```json
{
  "api_key": "custom_api_key",
  "additional_param": "value"
}
```

Для сценария Custom структура credentials может быть произвольной, в зависимости от требований внешней системы оплаты. Также необходимо указать `redirect_url` в модели Device.

### Настройка учетных данных через Django Admin

1. Войдите в Django Admin (`/admin/`)
2. Перейдите в раздел "Merchant Credentials"
3. Нажмите "Add Merchant Credentials"
4. Выберите мерчанта
5. Укажите сценарий (Yookassa, TBank или Custom)
6. Введите учетные данные в формате JSON
7. Сохраните

**Важно:** Для каждой комбинации (мерчант, сценарий) может существовать только одна запись с учетными данными.

### Настройка сценария для устройства

1. Войдите в Django Admin (`/admin/`)
2. Перейдите в раздел "Devices"
3. Выберите устройство для редактирования
4. В поле "Payment scenario" выберите нужный сценарий
5. Если выбран сценарий "Custom", убедитесь, что заполнено поле "Redirect url"
6. Сохраните

### Обработка платежей

При создании заказа система автоматически:

1. Определяет сценарий оплаты для устройства (`device.payment_scenario`)
2. Получает учетные данные мерчанта для этого сценария
3. Выполняет соответствующий сценарий:
   - **Yookassa**: создает платеж через API ЮKassa с учетными данными мерчанта
   - **TBank**: создает платеж через API TBank с учетными данными мерчанта
   - **Custom**: перенаправляет пользователя на `device.redirect_url` с параметрами заказа

Если учетные данные для выбранного сценария не найдены, заказ получает статус `failed` и возвращается ошибка.

### Логирование

Все операции, связанные со сценариями оплаты, логируются:

- Выбор сценария для устройства
- Получение учетных данных мерчанта
- Обработка платежа с указанием сценария
- Ошибки при отсутствии учетных данных или некорректной конфигурации

Логи можно найти в файле `logs/coffee_payment.log`.

## Экран информации о заказе

Для сценариев Yookassa и TBank система отображает промежуточный экран с информацией о заказе перед переходом к оплате. Это повышает прозрачность процесса и позволяет пользователю проверить детали заказа.

### Отображаемая информация

- Логотип мерчанта (если настроен `logo_url`)
- Адрес кофемашины (`device.location`)
- Название напитка
- Размер напитка (маленький/средний/большой)
- Цена в рублях
- Дополнительная информация для клиентов (если настроен `client_info`)
- Кнопка "Перейти к оплате"

### Технические детали

**View функции:**
- `show_order_info()` — отображает экран с информацией о заказе
- `initiate_payment()` — обрабатывает POST-запрос при нажатии кнопки оплаты

**URL endpoint:**
- `/v1/initiate-payment` — инициация платежа после подтверждения заказа

**Шаблон:**
- `templates/payments/order_info_screen.html` — адаптивный HTML с встроенным CSS и JavaScript

**Особенности:**
- Mobile-first дизайн (320px - 1920px)
- Состояния: загрузка, успех, ошибка
- Проверка протухания заказа перед созданием платежа
- Централизованные сообщения об ошибках из `user_messages.py`

**Сценарий Custom:**
Для сценария Custom экран информации о заказе не отображается — происходит прямой редирект на внешний URL.

## URL Endpoints

### Основные эндпоинты

- **`/v1/pay`** — основной эндпоинт для обработки QR-кодов и инициации платежного процесса (вызывает `process_payment_flow`)
- **`/v1/initiate-payment`** — инициация платежа после подтверждения заказа пользователем
- **`/v1/yook-pay-webhook`** — webhook для получения уведомлений от платежных систем

### Алиасы для обратной совместимости

Для обеспечения обратной совместимости со старыми QR-кодами система поддерживает следующие алиасы:

- **`/v1/tbank-pay`** → перенаправляет на `process_payment_flow` (legacy alias)
- **`/v1/yook-pay`** → перенаправляет на `process_payment_flow` (legacy alias)

Все алиасы обрабатываются одной и той же функцией `process_payment_flow()`, которая автоматически определяет правильный платежный сценарий на основе настроек устройства.

## Переменные окружения

Необходимые переменные для работы:

```bash
TMETR_TOKEN=<JWT токен для Tmetr API>
TMETR_HOST=<хост API Tmetr (например, test.telemetry.fwsoft.ru)>
SECRET_KEY=<Django секретный ключ>
DEBUG=<True/False>
DATABASE_URL=<подключение к PostgreSQL>
ORDER_EXPIRATION_MINUTES=<время протухания заказа в минутах (по умолчанию 15)>
```

## Развертывание

### Локальное развертывание
```bash
docker-compose up -d
```

### Просмотр логов
```bash
docker-compose logs -f
```

### Остановка
```bash
docker-compose down
```
