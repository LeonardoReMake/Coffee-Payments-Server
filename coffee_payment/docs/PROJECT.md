# Coffee Payments Server — Документация проекта

## Краткое описание бизнес-задачи

Проект — это **MVP версия** сервера для обработки платежей в системе кофейных автоматов. Он предоставляет API для управления устройствами (кофемашинами), обработки заказов напитков и интеграции с платежными системами (ЮKassa, ТБанк). Сервис позволяет мерчантам (владельцам кофемашин) принимать платежи, отслеживать статус заказов. Система предназначена для автоматизации оплаты напитков в сетях кофейных автоматов.

## Используемые технологии

### Языки программирования
- **Python 3.x** — основной язык разработки бэкенда

### Фреймворки и библиотеки
- **Django 5.1.4** — веб-фреймворк для создания REST API и обработки HTTP-запросов
- **Django REST Framework 3.15.2** — расширение для более удобной работы с REST API
- **Requests 2.32.3** — библиотека для выполнения HTTP-запросов к внешним API
- **Paho MQTT 2.1.0** — клиент MQTT для взаимодействия с IoT-устройствами
- **YooKassa 3.5.0** — SDK для интеграции с платежной системой ЮKassa
- **Psycopg2 2.9.10** — драйвер для подключения к PostgreSQL

### База данных
- **PostgreSQL** — реляционная СУБД для хранения данных о мерчантах, устройствах, заказах и платежах

### Инструменты сборки, тестирования и деплоя
- **Docker** — контейнеризация приложения
- **Docker Compose** — орхестрация контейнеров для локального развертывания
- **pip** — менеджер пакетов Python
- **Django ORM** — встроенная система управления моделями данных

## Архитектура проекта

### Архитектурный паттерн
Проект использует классическую **MVC архитектуру** (Model-View-Controller) с элементами REST API:

- **Models** — определяют структуру данных в БД (Merchant, Device, Order, Payment, Receipt и т.д.)
- **Views** — обрабатывают HTTP-запросы и возвращают ответы (JSON или HTML)
- **Controllers** — встроены в Views, управляют бизнес-логикой
- **Services** — отдельные модули для работы с внешними API (Tmetr, YooKassa, QR-коды)

### Основные компоненты системы

#### 1. **API слой (Views)**
- Обработка QR-кодов с кофемашин
- Инициация платежей через YooKassa
- Обработка webhook'ов от платежных систем
- Управление заказами и статусами

#### 2. **Сервисный слой (Services)**
- `yookassa_service.py` — интеграция с платежной системой ЮKassa
- `tmetr_service.py` — интеграция с API Tmetr для управления кофемашинами
- `qr_code_service.py` — валидация QR-кодов и редиректы
- `telemetry_service.py` — получение информации о напитках с устройств

#### 3. **Слой данных (Models)**
- `Merchant` — информация о владельцах кофемашин
- `Device` — данные о кофемашинах (статус, локация, привязка к мерчанту)
- `Drink` — каталог напитков с ценами
- `Order` — заказы напитков с детализированной статусной моделью (7 статусов) и механизмом протухания
- `Payment` — информация о платежах
- `Receipt` — чеки для отправки пользователям
- `TBankPayment` — платежи через Tbank

#### 4. **Утилиты**
- `logging.py` — централизованное логирование всех операций

### Взаимодействие компонентов

```
Клиент (QR-код с кофемашины)
        ↓
API Gateway (views.py)
        ↓
    ┌───────────────────────┐
    │  Валидация запроса    │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │  QR Code Service      │
    │  (проверка устройства)│
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │  YooKassa Service     │
    │  (создание платежа)   │
    └───────────────────────┘
        ↓
   Redirect to Payment URL
        ↓
[Пользователь оплачивает]
        ↓
    Webhook от YooKassa
        ↓
    ┌───────────────────────┐
    │ Update Order Status   │
    │ (Models)              │
    └───────────────────────┘
        ↓
    ┌───────────────────────┐
    │ Tmetr Service         │
    │ (отправить команду    │
    │  приготовления)       │
    └───────────────────────┘
        ↓
    Кофемашина готовит напиток
```

## Основные файлы и директории

### Корневая директория
```
coffee_payment/                    # Корневая папка проекта
├── README.md                      # Основная документация проекта
├── requirements.txt               # Зависимости Python
├── manage.py                      # Управление Django проектом
├── docker-compose.yml             # Конфигурация для запуска в Docker
├── Dockerfile                     # Образ приложения
├── entrypoint.sh                  # Скрипт инициализации контейнера
└── run.sh                         # Скрипт для локального запуска
```

### Папка `coffee_payment/` — конфигурация Django
```
coffee_payment/
├── __init__.py                    # Инициализация пакета
├── settings.py                    # Основные настройки проекта (БД, приложения, API ключи)
├── urls.py                        # Маршруты приложения
├── asgi.py                        # ASGI конфигурация для async серверов
├── wsgi.py                        # WSGI конфигурация для WSGI серверов
└── __pycache__/                   # Кэш скомпилированного Python кода
```

### Папка `payments/` — основное приложение
```
payments/
├── __init__.py
├── admin.py                       # Регистрация моделей в Django Admin
├── apps.py                        # Конфигурация приложения
├── models.py                      # Модели данных (Merchant, Device, Order, Payment и т.д.)
├── tests.py                       # Тесты приложения
├── views.py                       # API endpoints и обработчики запросов
├── migrations/                    # Миграции базы данных
│   ├── __init__.py
│   ├── 0001_initial.py            # Начальная миграция
│   ├── 0002_...py                 # Последующие изменения схемы
│   └── ...
├── services/                      # Сервисы для работы с внешними API
│   ├── yookassa_service.py        # Интеграция с ЮKassa
│   ├── tmetr_service.py           # Интеграция с Tmetr API
│   ├── qr_code_service.py         # Обработка QR-кодов
│   ├── telemetry_service.py       # Получение телеметрии с устройств
│   ├── mqtt_yaclient.py           # MQTT клиент для Yandex Cloud
│   ├── cm_mqtt.py                 # MQTT команды для кофемашин
│   └── __pycache__/
├── utils/                         # Вспомогательные утилиты
│   ├── logging.py                 # Централизованное логирование
│   └── __pycache__/
└── __pycache__/
```

### Папка `templates/` — HTML шаблоны
```
templates/
└── payments/
    ├── error_page.html            # Страница ошибки
    └── receipt_data_form.html     # Форма для ввода данных чека
```

### Папка `static/` — статические файлы
```
static/                           # CSS, JS, изображения (если требуется)
```

### Папка `docs/` — документация
```
docs/                             # Папка с документацией проекта
└── PROJECT.md                     # Этот файл
```

### Папка `logs/` — логи приложения
```
logs/                             # Логи выполнения приложения
```

## Основные потоки данных

### 1. Инициирование платежа (QR-код)
1. Клиент сканирует QR-код на кофемашине
2. Запрос попадает в `qr_code_redirect()`
3. Проверяется существование Device и активность Merchant
4. Выполняется редирект на сервис обработки платежа

### 2. Обработка платежа
1. Запрос в `yookassa_payment_process()`
2. Получается информация о напитке из telemetry service
3. Создается Order со статусом `created` и временем протухания (expires_at)
4. Создается платеж через YooKassa API, статус меняется на `pending`
5. Пользователь редиректится на страницу оплаты

### 3. Обработка результата платежа (Webhook)
1. YooKassa отправляет webhook при успешном платеже
2. `yookassa_payment_result_webhook()` проверяет, не протух ли заказ
3. Статус Order обновляется: `pending` → `paid` (при успехе) или `not_paid` (при отмене)
4. Отправляется команда на кофемашину через Tmetr API, статус меняется на `make_pending`
5. После приготовления статус меняется на `successful`
6. При критических ошибках статус меняется на `failed`

## Статусная модель заказов

Система использует детализированную статусную модель для отслеживания жизненного цикла заказа:

1. **created** — Заказ создан после валидации
2. **pending** — Платеж создан, ожидается оплата
3. **paid** — Оплата прошла успешно
4. **not_paid** — Оплата не прошла
5. **make_pending** — Команда на приготовление отправлена
6. **successful** — Заказ успешно завершен
7. **failed** — Заказ не может быть завершен (критическая ошибка)

### Механизм протухания заказов

Каждый заказ имеет поле `expires_at`, которое автоматически устанавливается при создании. Время протухания настраивается через параметр `ORDER_EXPIRATION_MINUTES` (по умолчанию 15 минут). Протухшие заказы не обрабатываются системой.

## Переменные окружения

Необходимые переменные для работы:

```bash
TMETR_TOKEN=<JWT токен для Tmetr API>
TMETR_HOST=<хост API Tmetr (например, test.telemetry.fwsoft.ru)>
SECRET_KEY=<Django секретный ключ>
DEBUG=<True/False>
DATABASE_URL=<подключение к PostgreSQL>
ORDER_EXPIRATION_MINUTES=<время протухания заказа в минутах (по умолчанию 15)>
```

## Развертывание

### Локальное развертывание
```bash
docker-compose up -d
```

### Просмотр логов
```bash
docker-compose logs -f
```

### Остановка
```bash
docker-compose down
```
