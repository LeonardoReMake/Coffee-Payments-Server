# Coffee Payments Server ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∏

–ü—Ä–æ–µ–∫—Ç ‚Äî —ç—Ç–æ **MVP –≤–µ—Ä—Å–∏—è** —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ—Ñ–µ–π–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–æ–≤. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞–º–∏), –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞–ø–∏—Ç–∫–æ–≤ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (–ÆKassa, –¢–ë–∞–Ω–∫). –°–µ—Ä–≤–∏—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–µ—Ä—á–∞–Ω—Ç–∞–º (–≤–ª–∞–¥–µ–ª—å—Ü–∞–º –∫–æ—Ñ–µ–º–∞—à–∏–Ω) –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã –Ω–∞–ø–∏—Ç–∫–æ–≤ –≤ —Å–µ—Ç—è—Ö –∫–æ—Ñ–µ–π–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–æ–≤.

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

### –Ø–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Python 3.x** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±—ç–∫–µ–Ω–¥–∞

### –§—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **Django 5.1.4** ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è REST API –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
- **Django REST Framework 3.15.2** ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å REST API
- **Requests 2.32.3** ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API
- **Paho MQTT 2.1.0** ‚Äî –∫–ª–∏–µ–Ω—Ç MQTT –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å IoT-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- **YooKassa 3.5.0** ‚Äî SDK –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ÆKassa
- **Psycopg2 2.9.10** ‚Äî –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **PostgreSQL** ‚Äî —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –°–£–ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ä—á–∞–Ω—Ç–∞—Ö, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –∑–∞–∫–∞–∑–∞—Ö –∏ –ø–ª–∞—Ç–µ–∂–∞—Ö

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–ø–ª–æ—è
- **Docker** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Docker Compose** ‚Äî –æ—Ä—Ö–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- **pip** ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ Python
- **Django ORM** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª—è–º–∏ –¥–∞–Ω–Ω—ã—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é **MVC –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** (Model-View-Controller) —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ REST API:

- **Models** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (Merchant, Device, Order, Payment, Receipt –∏ —Ç.–¥.)
- **Views** ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç HTTP-–∑–∞–ø—Ä–æ—Å—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—Ç–≤–µ—Ç—ã (JSON –∏–ª–∏ HTML)
- **Controllers** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ Views, —É–ø—Ä–∞–≤–ª—è—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- **Services** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ API (Tmetr, YooKassa, QR-–∫–æ–¥—ã)

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 1. **API —Å–ª–æ–π (Views)**
- `process_payment_flow()` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞, –≤–∫–ª—é—á–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –ø–æ –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º
- `initiate_payment()` ‚Äî –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `yookassa_payment_result_webhook()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏

#### 2. **–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (Services)**
- `payment_scenario_service.py` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –æ–ø–ª–∞—Ç—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- `yookassa_service.py` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ÆKassa
- `t_bank_service.py` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π TBank
- `tmetr_service.py` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API Tmetr –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞–º–∏
- `qr_code_service.py` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –º–µ—Ä—á–∞–Ω—Ç–æ–≤
- `telemetry_service.py` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `validation_service.py` ‚Äî —Ü–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π –∑–∞–∫–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–ª–∞—Ç–µ–∂–∞

#### 3. **–°–ª–æ–π –¥–∞–Ω–Ω—ã—Ö (Models)**
- `Merchant` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–ª–∞–¥–µ–ª—å—Ü–∞—Ö –∫–æ—Ñ–µ–º–∞—à–∏–Ω
- `Device` ‚Äî –¥–∞–Ω–Ω—ã–µ –æ –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞—Ö (—Å—Ç–∞—Ç—É—Å, –ª–æ–∫–∞—Ü–∏—è, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ—Ä—á–∞–Ω—Ç—É, —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–ø–ª–∞—Ç—ã, –ª–æ–≥–æ—Ç–∏–ø, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —Å—Ç–∞—Ç—É—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞)
- `MerchantCredentials` ‚Äî —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä—á–∞–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (Yookassa, TBank, Custom)
- `Drink` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –Ω–∞–ø–∏—Ç–∫–æ–≤ —Å —Ü–µ–Ω–∞–º–∏
- `Order` ‚Äî –∑–∞–∫–∞–∑—ã –Ω–∞–ø–∏—Ç–∫–æ–≤ —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—É—Å–Ω–æ–π –º–æ–¥–µ–ª—å—é (7 —Å—Ç–∞—Ç—É—Å–æ–≤), –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º drink_number –∏–∑ QR-–∫–æ–¥–∞
- `Payment` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
- `Receipt` ‚Äî —á–µ–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- `TBankPayment` ‚Äî –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Tbank

#### 4. **–£—Ç–∏–ª–∏—Ç—ã**
- `logging.py` ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- `user_messages.py` ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
–ö–ª–∏–µ–Ω—Ç (QR-–∫–æ–¥ —Å –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã)
        ‚Üì
GET /v1/pay ‚Üí process_payment_flow()
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –¶–ï–ü–û–ß–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ô                    ‚îÇ
    ‚îÇ  (Validation Service)                 ‚îÇ
    ‚îÇ                                       ‚îÇ
    ‚îÇ  1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–µ—à–∞ –∑–∞–ø—Ä–æ—Å–∞            ‚îÇ
    ‚îÇ     (placeholder - –≤—Å–µ–≥–¥–∞ —É—Å–ø–µ—à–Ω–æ)    ‚îÇ
    ‚îÇ          ‚Üì                            ‚îÇ
    ‚îÇ  2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞     ‚îÇ
    ‚îÇ     - –ó–∞–∫–∞–∑ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å   ‚îÇ
    ‚îÇ     - –ó–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤–∞–ª–∏–¥–µ–Ω ‚Üí    ‚îÇ
    ‚îÇ       –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π       ‚îÇ
    ‚îÇ     - –ó–∞–∫–∞–∑ –ø—Ä–æ—Ç—É—Ö ‚Üí –æ—à–∏–±–∫–∞           ‚îÇ
    ‚îÇ          ‚Üì                            ‚îÇ
    ‚îÇ  3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞       ‚îÇ
    ‚îÇ     (heartbeat —á–µ—Ä–µ–∑ Tmetr API)       ‚îÇ
    ‚îÇ     - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å  ‚îÇ
    ‚îÇ     - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ñ–ª–∞–π–Ω ‚Üí –æ—à–∏–±–∫–∞      ‚îÇ
    ‚îÇ                                       ‚îÇ
    ‚îÇ  –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω    ‚îÇ
    ‚îÇ  –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ—Ä–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É          ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –í–∞–ª–∏–¥–∞—Ü–∏—è Device +   ‚îÇ
    ‚îÇ  Merchant             ‚îÇ
    ‚îÇ  (QR Code Service)    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚îÇ
    ‚îÇ  –æ –Ω–∞–ø–∏—Ç–∫–µ            ‚îÇ
    ‚îÇ  (Tmetr Service)      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ Order       ‚îÇ
    ‚îÇ  (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)     ‚îÇ
    ‚îÇ  (status='created')   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Payment  ‚îÇ
    ‚îÇ  Scenario             ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                                     ‚îÇ
    ‚ñº                                     ‚ñº
Yookassa/TBank                      Custom
    ‚îÇ                                     ‚îÇ
    ‚ñº                                     ‚ñº
Redirect to                    execute_custom_scenario()
/v1/order-status-page
    ‚îÇ
    ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Unified Order Status Page         ‚îÇ
    ‚îÇ (show_order_status_page)          ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚îÇ - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ  ‚îÇ
    ‚îÇ - –î–ª—è status=created: –∫–Ω–æ–ø–∫–∞      ‚îÇ
    ‚îÇ   "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"              ‚îÇ
    ‚îÇ - –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤: polling    ‚îÇ
    ‚îÇ   –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É                  ‚îÇ
    ‚îÇ   (GET /v1/order-status/<id>)     ‚îÇ
    ‚îÇ - –û–±–Ω–æ–≤–ª—è–µ—Ç UI –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏   ‚îÇ
    ‚îÇ - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞        ‚îÇ
    ‚îÇ   –∑–∞–∫–∞–∑–∞ (expires_at)             ‚îÇ
    ‚îÇ - –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"       ‚îÇ
    ‚îÇ   –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ not_paid            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ")
    initiate_payment()
        ‚Üì
   Payment Service (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞)
        ‚Üì
   Redirect to Payment URL
        ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç]
        ‚Üì
    –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞
    /v1/order-status-page?order_id=...
        ‚Üì
    Unified Order Status Page
    (–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ polling)
        ‚Üë
        ‚îÇ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
        ‚Üì
    Webhook –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Update Order Status   ‚îÇ
    ‚îÇ (Models)              ‚îÇ
    ‚îÇ pending ‚Üí paid        ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Tmetr Service         ‚îÇ
    ‚îÇ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É    ‚îÇ
    ‚îÇ  –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è)       ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Update Order Status   ‚îÇ
    ‚îÇ paid ‚Üí make_pending   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
    –ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –≥–æ—Ç–æ–≤–∏—Ç –Ω–∞–ø–∏—Ç–æ–∫
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Update Order Status   ‚îÇ
    ‚îÇ make_pending ‚Üí        ‚îÇ
    ‚îÇ successful            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

### –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
```
coffee_payment/                    # –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ README.md                      # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ requirements.txt               # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ manage.py                      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Django –ø—Ä–æ–µ–∫—Ç–æ–º
‚îú‚îÄ‚îÄ docker-compose.yml             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ Docker
‚îú‚îÄ‚îÄ Dockerfile                     # –û–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ entrypoint.sh                  # –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
‚îî‚îÄ‚îÄ run.sh                         # –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
```

### –ü–∞–ø–∫–∞ `coffee_payment/` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Django
```
coffee_payment/
‚îú‚îÄ‚îÄ __init__.py                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞
‚îú‚îÄ‚îÄ settings.py                    # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–ë–î, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, API –∫–ª—é—á–∏)
‚îú‚îÄ‚îÄ urls.py                        # –ú–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ asgi.py                        # ASGI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è async —Å–µ—Ä–≤–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ wsgi.py                        # WSGI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è WSGI —Å–µ—Ä–≤–µ—Ä–æ–≤
‚îî‚îÄ‚îÄ __pycache__/                   # –ö—ç—à —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Python –∫–æ–¥–∞
```

### –ü–∞–ø–∫–∞ `payments/` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```
payments/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ admin.py                       # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ Django Admin
‚îú‚îÄ‚îÄ apps.py                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ models.py                      # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (Merchant, Device, Order, Payment –∏ —Ç.–¥.)
‚îú‚îÄ‚îÄ tests.py                       # –¢–µ—Å—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ views.py                       # API endpoints –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ migrations/                    # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ 0001_initial.py            # –ù–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ 0002_...py                 # –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ services/                      # –°–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
‚îÇ   ‚îú‚îÄ‚îÄ payment_scenario_service.py # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –æ–ø–ª–∞—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ yookassa_service.py        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa
‚îÇ   ‚îú‚îÄ‚îÄ t_bank_service.py          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TBank
‚îÇ   ‚îú‚îÄ‚îÄ tmetr_service.py           # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tmetr API
‚îÇ   ‚îú‚îÄ‚îÄ qr_code_service.py         # –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ telemetry_service.py       # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îÇ   ‚îú‚îÄ‚îÄ validation_service.py      # –¶–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π –∑–∞–∫–∞–∑–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ mqtt_yaclient.py           # MQTT –∫–ª–∏–µ–Ω—Ç –¥–ª—è Yandex Cloud
‚îÇ   ‚îú‚îÄ‚îÄ cm_mqtt.py                 # MQTT –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω
‚îÇ   ‚îî‚îÄ‚îÄ __pycache__/
‚îú‚îÄ‚îÄ utils/                         # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ logging.py                 # –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ __pycache__/
‚îî‚îÄ‚îÄ __pycache__/
```

### –ü–∞–ø–∫–∞ `templates/` ‚Äî HTML —à–∞–±–ª–æ–Ω—ã
```
templates/
‚îî‚îÄ‚îÄ payments/
    ‚îú‚îÄ‚îÄ error_page.html            # –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ —Å –±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º
    ‚îú‚îÄ‚îÄ receipt_data_form.html     # –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ–∫–∞
    ‚îî‚îÄ‚îÄ order_status_page.html     # Unified —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
```

### –ü–∞–ø–∫–∞ `static/` ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
```
static/                           # CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
```

### –ü–∞–ø–∫–∞ `docs/` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```
docs/                             # –ü–∞–ø–∫–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ PROJECT.md                     # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

### –ü–∞–ø–∫–∞ `logs/` ‚Äî –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```
logs/                             # –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (QR-–∫–æ–¥)
1. –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –Ω–∞ –∫–æ—Ñ–µ–º–∞—à–∏–Ω–µ
2. –ó–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `process_payment_flow()` —á–µ—Ä–µ–∑ URL `/v1/pay`
3. –í–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (deviceUuid, drinkNo, drinkName, size, uuid)
4. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π (—Ö–µ—à –∑–∞–ø—Ä–æ—Å–∞, —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ Device –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å Merchant —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `validate_device()` –∏ `validate_merchant()` –∏–∑ qr_code_service
6. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–∏—Ç–∫–µ –∏–∑ Tmetr API
7. –°–æ–∑–¥–∞–µ—Ç—Å—è Order —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `created` –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è (expires_at), –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–∫–∞–∑
8. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (`device.payment_scenario`)
9. **–î–ª—è Yookassa/TBank**: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ unified order status page (`/v1/order-status-page?order_id=X`)
10. **–î–ª—è Custom**: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤–Ω–µ—à–Ω–∏–π URL —á–µ—Ä–µ–∑ `PaymentScenarioService.execute_scenario()`

### 2. Unified Order Status Page
1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ —á–µ—Ä–µ–∑ API (`GET /v1/order-status/<order_id>`)
2. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ, –≤–∫–ª—é—á–∞—è `expires_at` –∏ —Å—Ç–∞—Ç—É—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
3. **–î–ª—è —Å—Ç–∞—Ç—É—Å–∞ `created`**:
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ —Å –∫–Ω–æ–ø–∫–æ–π "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (expires_at)
   - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `initiate_payment()` —á–µ—Ä–µ–∑ POST-–∑–∞–ø—Ä–æ—Å
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
   - –°—Ç–∞—Ç—É—Å Order –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `pending`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
4. **–î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ `pending`, `paid`, `make_pending`**:
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è polling (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É) –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
   - UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
5. **–î–ª—è —Å—Ç–∞—Ç—É—Å–∞ `not_paid`**:
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"
   - Polling –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
6. **–î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ `successful`, `failed`**:
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
   - Polling –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (Webhook)
1. YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ
2. `yookassa_payment_result_webhook()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –ø—Ä–æ—Ç—É—Ö –ª–∏ –∑–∞–∫–∞–∑
3. –°—Ç–∞—Ç—É—Å Order –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `pending` ‚Üí `paid` (–ø—Ä–∏ —É—Å–ø–µ—Ö–µ) –∏–ª–∏ `not_paid` (–ø—Ä–∏ –æ—Ç–º–µ–Ω–µ)
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—É —á–µ—Ä–µ–∑ Tmetr API, —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `make_pending`
5. –ü–æ—Å–ª–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `successful`
6. –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `failed`
7. Unified Order Status Page –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ polling

## –¶–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π –∑–∞–∫–∞–∑–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Ü–µ–ø–æ—á–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–ª–∞—Ç–µ–∂–∞. –í–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ–º –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

–¶–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é `process_payment_flow()` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞, –Ω–æ –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º.

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–π:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–µ—à–∞ –∑–∞–ø—Ä–æ—Å–∞** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ (placeholder —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å–æ–∑–¥–∞–Ω –ª–∏ —É–∂–µ –∑–∞–∫–∞–∑ —Å –¥–∞–Ω–Ω—ã–º UUID
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –æ–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ Tmetr heartbeat API

–ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
- –¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–∞–ª—å–Ω–µ–π—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏

#### OrderValidationService

–°–µ—Ä–≤–∏—Å, –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—â–∏–π –≤—Å—é –ª–æ–≥–∏–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–π.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `coffee_payment/payments/services/validation_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```python
class OrderValidationService:
    @staticmethod
    def validate_request_hash(request_params: dict) -> tuple[bool, str]:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–µ—à–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏.
        –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî placeholder, –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö.
        """
        
    @staticmethod
    def check_order_existence(order_uuid: str) -> tuple[bool, str, Order | None]:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–Ω—É–∂–Ω–æ_—Å–æ–∑–¥–∞—Ç—å_–Ω–æ–≤—ã–π, —Å–æ–æ–±—â–µ–Ω–∏–µ_–æ–±_–æ—à–∏–±–∫–µ, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π_–∑–∞–∫–∞–∑)
        """
        
    @staticmethod
    def check_device_online_status(device_uuid: str) -> tuple[bool, str]:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ Tmetr heartbeat API.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_–æ–Ω–ª–∞–π–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ_–æ–±_–æ—à–∏–±–∫–µ)
        """
        
    @staticmethod
    def execute_validation_chain(request_params: dict, device_uuid: str, order_uuid: str) -> dict:
        """
        –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–π —Å —Ä–∞–Ω–Ω–∏–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
        """
```

#### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ TmetrService

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è heartbeat –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:

```python
def get_device_heartbeat(self, device_id: str) -> Dict[str, Any]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Tmetr API.
    
    Endpoint: POST /api/ui/v1/stat/heartbeat/recent
    Headers: X-TimeZoneOffset (—á–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å–µ—Ä–≤–µ—Ä–∞)
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–∏–≥–Ω–∞–ª–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å timestamp.
    """
```

**API Endpoint:** `POST https://{TMETR_HOST}/api/ui/v1/stat/heartbeat/recent`

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- `Authorization: Bearer {TMETR_TOKEN}`
- `X-TimeZoneOffset: {timezone_offset}` ‚Äî —Å–º–µ—â–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "deviceIds": ["device-uuid"],
  "offset": 0,
  "limit": 1
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "content": [
    {
      "deviceId": "device-uuid",
      "deviceIotName": "device-name",
      "heartbeatCreatedAt": 1699876543000
    }
  ],
  "totalElements": 1,
  "offset": 0,
  "limit": 1
}
```

### –î–µ—Ç–∞–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–π

#### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–µ—à–∞ –∑–∞–ø—Ä–æ—Å–∞

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞, –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ QR-–∫–æ–¥–æ–≤.

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** Placeholder, –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö. –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–∑–∂–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–∞.

**–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:** `invalid_request_hash` ‚Äî "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–Ω–æ–≤–∞."

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

**–¶–µ–ª—å:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–∫–∞–∑–æ–≤, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑.

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `created` –∏ –Ω–µ –ø—Ä–æ—Ç—É—Ö ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ç—É—Ö (expires_at < —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è) ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –¥—Ä—É–≥–∏–º —Å—Ç–∞—Ç—É—Å–æ–º ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `Order.is_expired()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—è `expires_at`.

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** UUID –∑–∞–∫–∞–∑–∞, —Å—Ç–∞—Ç—É—Å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Ç—É—Ö—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤.

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –æ–Ω–ª–∞–π–Ω –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞–ø–∏—Ç–æ–∫.

**–õ–æ–≥–∏–∫–∞:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ Tmetr heartbeat API —Å UUID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. –ü–æ–ª—É—á–∏—Ç—å timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat (`heartbeatCreatedAt`)
3. –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º heartbeat
4. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ—Ä–æ–≥–æ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (`DEVICE_ONLINE_THRESHOLD_MINUTES`)
5. –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥ ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ñ–ª–∞–π–Ω
6. –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–æ—Ä–æ–≥–∞ ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API:**
- –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
- –û—à–∏–±–∫–∏ API (4xx/5xx) ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ heartbeat
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö heartbeat ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ñ–ª–∞–π–Ω

**–†–∞–±–æ—Ç–∞ —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏:**
- Timestamp heartbeat –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ —Å–µ—Ä–≤–µ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Django timezone-aware datetime –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- –í –∑–∞–ø—Ä–æ—Å –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-TimeZoneOffset`

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** UUID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, timestamp heartbeat, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω), –ø–æ—Ä–æ–≥.

**–°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö:**
- `device_offline` ‚Äî "–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
- `heartbeat_check_failed` ‚Äî "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ settings.py

```python
# –ü–æ—Ä–æ–≥ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
# –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π heartbeat —Å—Ç–∞—Ä—à–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ñ–ª–∞–π–Ω
DEVICE_ONLINE_THRESHOLD_MINUTES = 5
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π: 5 –º–∏–Ω—É—Ç
- –î–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π: 10-15 –º–∏–Ω—É—Ç
- –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: 1-2 –º–∏–Ω—É—Ç—ã

#### –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `coffee_payment/payments/user_messages.py`:

```python
ERROR_MESSAGES = {
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ...
    'invalid_request_hash': '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å–Ω–æ–≤–∞.',
    'device_offline': '–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.',
    'heartbeat_check_failed': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ process_payment_flow

–¶–µ–ø–æ—á–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–π –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:

```python
def process_payment_flow(request):
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    device_uuid = request.GET.get('deviceUuid')
    order_uuid = request.GET.get('uuid')
    # ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ...
    
    # 2. –ù–û–í–û–ï: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–π
    validation_result = OrderValidationService.execute_validation_chain(
        request_params={...},
        device_uuid=device_uuid,
        order_uuid=order_uuid
    )
    
    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    if not validation_result['valid']:
        return render_error_page(validation_result['error_message'], 400)
    
    # 4. –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–≤–∞–ª–∏–¥–∞—Ü–∏—è device/merchant, –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–ø–∏—Ç–∫–µ)
    # ...
    
    # 5. –£—Å–ª–æ–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    if validation_result['should_create_new_order']:
        order = Order.objects.create(...)
    else:
        order = validation_result['existing_order']
    
    # 6. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –ø–ª–∞—Ç–µ–∂–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é
    # ...
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —ç—Ç–∞–ø—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

**–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:**
```
[timestamp] [—É—Ä–æ–≤–µ–Ω—å] [—Ñ—É–Ω–∫—Ü–∏—è] —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```
[2025-11-13T10:30:00+03:00] INFO [execute_validation_chain] Starting validation chain. device_uuid=abc-123, order_uuid=xyz-789
[2025-11-13T10:30:00+03:00] INFO [validate_request_hash] Hash validation passed (placeholder)
[2025-11-13T10:30:00+03:00] INFO [check_order_existence] Order xyz-789 not found, will create new order
[2025-11-13T10:30:01+03:00] INFO [check_device_online_status] Checking device abc-123 heartbeat
[2025-11-13T10:30:01+03:00] INFO [check_device_online_status] Device abc-123 is online. Last heartbeat: 2025-11-13T10:28:00+03:00, threshold: 5 minutes
[2025-11-13T10:30:01+03:00] INFO [execute_validation_chain] Validation chain completed successfully
```

**–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö:**
```
[2025-11-13T10:30:01+03:00] ERROR [check_device_online_status] Device abc-123 is offline. Last heartbeat: 2025-11-13T10:20:00+03:00, threshold: 5 minutes
[2025-11-13T10:30:01+03:00] INFO [execute_validation_chain] Validation chain failed at device status check
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

**–£—Å–ø–µ—à–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é
- –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ (~1-2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ Tmetr API –∑–∞–ø—Ä–æ—Å)

**–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω `error_page.html`
- Mobile-first –¥–∏–∑–∞–π–Ω, –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Å–∫—Ä—ã—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- HTTP —Å—Ç–∞—Ç—É—Å 400 (Bad Request)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ß–∞—Å—Ç–æ—Ç—É –æ—Ç–∫–∞–∑–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º
- –ß–∞—Å—Ç–æ—Ç—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ—Ñ–ª–∞–π–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ Tmetr heartbeat API
- –ß–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ö–µ—à–∞** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ heartbeat** ‚Äî –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ 30-60 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API
3. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è —Ü–µ–ø–æ—á–∫–∞** ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. **Retry –ª–æ–≥–∏–∫–∞** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö Tmetr API
5. **–ú–µ—Ç—Ä–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** ‚Äî —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—à–∏–±–æ–∫

## –°—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—É—Å–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–∫–∞–∑–∞:

1. **created** ‚Äî –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **pending** ‚Äî –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞
3. **paid** ‚Äî –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
4. **not_paid** ‚Äî –û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞
5. **make_pending** ‚Äî –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
6. **successful** ‚Äî –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
7. **failed** ‚Äî –ó–∞–∫–∞–∑ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞)

### –ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

–ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –∏–º–µ–µ—Ç –ø–æ–ª–µ `expires_at`, –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –í—Ä–µ–º—è –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `ORDER_EXPIRATION_MINUTES` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15 –º–∏–Ω—É—Ç). –ü—Ä–æ—Ç—É—Ö—à–∏–µ –∑–∞–∫–∞–∑—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–ø–ª–∞—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –æ–ø–ª–∞—Ç—ã.

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–ª–∞—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:

1. **Yookassa** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ÆKassa (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
2. **TBank** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π TBank
3. **Custom** ‚Äî –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤–Ω–µ—à–Ω—é—é —Å–∏—Å—Ç–µ–º—É –æ–ø–ª–∞—Ç—ã

–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `settings.py`:

```python
PAYMENT_SCENARIOS = ['Yookassa', 'TBank', 'Custom']
DEFAULT_PAYMENT_SCENARIO = 'Yookassa'
```

### –ú–æ–¥–µ–ª—å Device

–ö–∞–∂–¥–∞—è –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ (Device) –∏–º–µ–µ—Ç –ø–æ–ª–µ `payment_scenario`, –∫–æ—Ç–æ—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:

```python
class Device(models.Model):
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
    payment_scenario = models.CharField(
        max_length=50,
        default='Yookassa',
        help_text='Payment scenario for this device'
    )
    logo_url = models.URLField(
        null=True, 
        blank=True,
        help_text='URL to merchant logo image displayed on order screen'
    )
    client_info = models.TextField(
        null=True,
        blank=True,
        help_text='Custom information displayed to customers on order screen'
    )
    client_error_info = models.TextField(
        null=True,
        blank=True,
        help_text='Custom information displayed to customers on error screens (e.g., support contact)'
    )
```

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (Yookassa). –°—Ü–µ–Ω–∞—Ä–∏–π –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ Django Admin –∏–ª–∏ API.

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤:**
- `logo_url` ‚Äî URL –ª–æ–≥–æ—Ç–∏–ø–∞ –º–µ—Ä—á–∞–Ω—Ç–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –∑–∞–∫–∞–∑–∞ –∏ –æ—à–∏–±–∫–∏
- `client_info` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–∫–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏)
- `client_error_info` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É: `<a href="tel:+79001234567">+7 900 123-45-67</a>`)

### –ú–æ–¥–µ–ª—å MerchantCredentials

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –º–µ—Ä—á–∞–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –û–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏ `MerchantCredentials`:

```python
class MerchantCredentials(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    merchant = models.ForeignKey(Merchant, on_delete=models.CASCADE, related_name='credentials')
    scenario = models.CharField(max_length=50)
    credentials = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = ('merchant', 'scenario')
```

–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –≤ –ø–æ–ª–µ `credentials`. –ö–∞–∂–¥—ã–π –º–µ—Ä—á–∞–Ω—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### Yookassa Credentials

```json
{
  "account_id": "1193510",
  "secret_key": "test_Ku1e9ZkX5OoTCm0k2m05Dg66XldJFHkER_9sw5LKE1E"
}
```

–ü–æ–ª—è:
- `account_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –≤ –ÆKassa
- `secret_key` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è API –ÆKassa

#### TBank Credentials

```json
{
  "shop_id": "ShopID123",
  "secret_key": "SecretKey456",
  "success_url": "https://example.com/success",
  "fail_url": "https://example.com/fail"
}
```

–ü–æ–ª—è:
- `shop_id` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –≤ TBank
- `secret_key` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è API TBank
- `success_url` ‚Äî URL –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- `fail_url` ‚Äî URL –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ

#### Custom Credentials

```json
{
  "api_key": "custom_api_key",
  "additional_param": "value"
}
```

–î–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è Custom —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ credentials –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã. –¢–∞–∫–∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å `redirect_url` –≤ –º–æ–¥–µ–ª–∏ Device.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Django Admin

1. –í–æ–π–¥–∏—Ç–µ –≤ Django Admin (`/admin/`)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "Merchant Credentials"
3. –ù–∞–∂–º–∏—Ç–µ "Add Merchant Credentials"
4. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä—á–∞–Ω—Ç–∞
5. –£–∫–∞–∂–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π (Yookassa, TBank –∏–ª–∏ Custom)
6. –í–≤–µ–¥–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
7. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–í–∞–∂–Ω–æ:** –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (–º–µ—Ä—á–∞–Ω—Ç, —Å—Ü–µ–Ω–∞—Ä–∏–π) –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

1. –í–æ–π–¥–∏—Ç–µ –≤ Django Admin (`/admin/`)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "Devices"
3. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. –í –ø–æ–ª–µ "Payment scenario" –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
5. –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π "Custom", —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ "Redirect url"
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–ø–ª–∞—Ç—ã –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (`device.payment_scenario`)
2. –ü–æ–ª—É—á–∞–µ—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ—Ä—á–∞–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
   - **Yookassa**: —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API –ÆKassa —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –º–µ—Ä—á–∞–Ω—Ç–∞
   - **TBank**: —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API TBank —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –º–µ—Ä—á–∞–Ω—Ç–∞
   - **Custom**: –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `device.redirect_url` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–∫–∞–∑–∞

–ï—Å–ª–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–∫–∞–∑ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `failed` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞.

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –æ–ø–ª–∞—Ç—ã, –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

- –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä—á–∞–Ω—Ç–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ü–µ–Ω–∞—Ä–∏—è
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–õ–æ–≥–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ —Ñ–∞–π–ª–µ `logs/coffee_payment.log`.

## Unified Order Status Page (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞)

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–∫–∞–∑–∞ ‚Äî –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ (–¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ Yookassa/TBank) –∏–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —Å—Ç–∞—Ç—É—Å—É –∑–∞–∫–∞–∑–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

### –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –õ–æ–≥–æ—Ç–∏–ø –º–µ—Ä—á–∞–Ω—Ç–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω `logo_url`)
- –ê–¥—Ä–µ—Å –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã (`device.location`)
- –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø–∏—Ç–∫–∞
- –†–∞–∑–º–µ—Ä –Ω–∞–ø–∏—Ç–∫–∞ (–º–∞–ª–µ–Ω—å–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–±–æ–ª—å—à–æ–π)
- –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
- –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (`expires_at`) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∏–∫–æ–Ω–∫–æ–π
- –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- –°—Ç–∞—Ç—É—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:

**created** (–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω):
- –ò–∫–æ–Ω–∫–∞: üìã
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è –æ–ø–ª–∞—Ç—ã"
- –ö–Ω–æ–ø–∫–∞: "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ" (–∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ `initiate_payment()`)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞: –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –ø—Ä–æ—Ç—É—Ö
- Polling: –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω)

**pending** (–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã):
- –ò–∫–æ–Ω–∫–∞: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –∑–∞–∫–∞–∑–∞..."
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info_pending`
- Polling: –∞–∫—Ç–∏–≤–µ–Ω

**paid** (–û–ø–ª–∞—á–µ–Ω–æ):
- –ò–∫–æ–Ω–∫–∞: –≥–∞–ª–æ—á–∫–∞ (—É—Å–ø–µ—Ö)
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –≥–æ—Ç–æ–≤–∏—Ç—å"
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info_paid`
- Polling: –∞–∫—Ç–∏–≤–µ–Ω

**not_paid** (–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞):
- –ò–∫–æ–Ω–∫–∞: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–æ—à–∏–±–∫–∞)
- –û–ø–∏—Å–∞–Ω–∏–µ: "–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞"
- –ö–Ω–æ–ø–∫–∞: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É" (—Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–ø–ª–∞—Ç—É)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info_not_paid`
- Polling: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**make_pending** (–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ):
- –ò–∫–æ–Ω–∫–∞: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ì–æ—Ç–æ–≤–∏–º –Ω–∞–ø–∏—Ç–æ–∫..."
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info_make_pending`
- Polling: –∞–∫—Ç–∏–≤–µ–Ω

**successful** (–ì–æ—Ç–æ–≤–æ):
- –ò–∫–æ–Ω–∫–∞: –≥–∞–ª–æ—á–∫–∞ (—É—Å–ø–µ—Ö)
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ù–∞–ø–∏—Ç–æ–∫ –≥–æ—Ç–æ–≤"
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `Device.client_info_successful`
- Polling: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**failed** (–û—à–∏–±–∫–∞):
- –ò–∫–æ–Ω–∫–∞: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–æ—à–∏–±–∫–∞)
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞"
- Polling: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –æ—Ç–ø—Ä–∞–≤–ª—è—è REST API –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏.

**–õ–æ–≥–∏–∫–∞ polling:**
- Polling –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤: `pending`, `paid`, `make_pending`
- Polling –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤: `created`, `successful`, `not_paid`, `failed`
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º polling –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (`expires_at`)
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –ø—Ä–æ—Ç—É—Ö –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ polling –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**View —Ñ—É–Ω–∫—Ü–∏–∏:**
- `show_order_status_page()` ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º JavaScript
- `get_order_status(order_id)` ‚Äî API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–∫–∞–∑–∞ (JSON)
- `initiate_payment()` ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"

**URL endpoints:**
- `/v1/order-status-page?order_id=<order_id>` ‚Äî unified —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
- `/v1/order-status/<order_id>` ‚Äî API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è polling)
- `/v1/initiate-payment` ‚Äî –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ `created`

**–®–∞–±–ª–æ–Ω:**
- `templates/payments/order_status_page.html` ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π HTML —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º CSS –∏ JavaScript

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Mobile-first –¥–∏–∑–∞–π–Ω (320px - 1920px)
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–∞ (–≤–∫–ª—é—á–∞—è `created`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (–¥–ª—è –Ω–µ-—Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
- –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–æ–ª—è—Ö
- –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ `created`
- –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ `not_paid`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ `user_messages.py`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ accessibility (high contrast mode, reduced motion)

**–ü–æ–ª—è Device –¥–ª—è —Å—Ç–∞—Ç—É—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:**
- `client_info` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ created (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)
- `client_info_pending` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ pending (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)
- `client_info_paid` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ paid (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)
- `client_info_not_paid` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ not_paid (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)
- `client_info_make_pending` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ make_pending (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)
- `client_info_successful` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ successful (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML)

**API Response (GET /v1/order-status/<order_id>):**
```json
{
  "order_id": "order-uuid",
  "status": "created",
  "drink_name": "–ê–º–µ—Ä–∏–∫–∞–Ω–æ",
  "drink_size": "—Å—Ä–µ–¥–Ω–∏–π",
  "price": 150.0,
  "expires_at": "2025-11-15T10:30:00+03:00",
  "device": {
    "location": "–û—Ñ–∏—Å, 1 —ç—Ç–∞–∂",
    "logo_url": "https://example.com/logo.png",
    "client_info": "–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7 900 123-45-67",
    "client_info_pending": "...",
    "client_info_paid": "...",
    "client_info_not_paid": "...",
    "client_info_make_pending": "...",
    "client_info_successful": "..."
  }
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –≤ Yookassa –∏ TBank —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:

**Yookassa:**
```python
return_url = f"https://{domain}/v1/order-status-page?order_id={order.id}"
```

**TBank:**
```python
success_url = f"https://{domain}/v1/order-status-page?order_id={order.id}"
```

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ—Å—à–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –æ–ø–ª–∞—Ç—ã –∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—é —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞.

## –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏

–°–∏—Å—Ç–µ–º–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã. –≠–∫—Ä–∞–Ω –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å —ç–∫—Ä–∞–Ω–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ.

### –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –õ–æ–≥–æ—Ç–∏–ø –º–µ—Ä—á–∞–Ω—Ç–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω `logo_url`)
- –ò–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (‚ö†Ô∏è)
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–û—à–∏–±–∫–∞"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω `client_error_info`)

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**View —Ñ—É–Ω–∫—Ü–∏—è:**
- `render_error_page(message, status_code, device=None)` ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —ç–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º –º–µ—Ä—á–∞–Ω—Ç–∞

**–®–∞–±–ª–æ–Ω:**
- `templates/payments/error_page.html` ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π HTML —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º CSS

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Mobile-first –¥–∏–∑–∞–π–Ω (320px - 1920px)
- –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å —ç–∫—Ä–∞–Ω–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏–∑ `user_messages.py`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±—Ä–µ–Ω–¥–∏–Ω–≥–∞ –º–µ—Ä—á–∞–Ω—Ç–∞ (–ª–æ–≥–æ—Ç–∏–ø –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
- Graceful degradation –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ accessibility (high contrast mode, reduced motion)
- –í—Å–µ —Å—Ç–∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã (inline CSS), –Ω–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ü–æ–ª—è Device –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∏:**
- `logo_url` ‚Äî URL –ª–æ–≥–æ—Ç–∏–ø–∞ –º–µ—Ä—á–∞–Ω—Ç–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ—à–∏–±–∫–∏
- `client_error_info` ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Å—ã–ª–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ —Ç.–¥.)

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
–§—É–Ω–∫—Ü–∏—è `render_error_page` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `device` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –±–µ–∑ –±—Ä–µ–Ω–¥–∏–Ω–≥–∞.

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è HTML –≤ client_error_info:**
```html
<!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω -->
–í–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã? –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º: <a href="tel:+79001234567">+7 900 123-45-67</a>

<!-- –°—Å—ã–ª–∫–∞ –Ω–∞ email -->
–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º: <a href="mailto:support@example.com">support@example.com</a>

<!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç -->
–ü–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ: <a href="https://example.com/support" target="_blank">example.com/support</a>

<!-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä -->
–í–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã? <br>
–ü–æ–∑–≤–æ–Ω–∏—Ç–µ: <a href="tel:+79001234567">+7 900 123-45-67</a><br>
–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ: <a href="mailto:support@example.com">support@example.com</a>
```

## URL Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

- **`/v1/pay`** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–æ–≤ –∏ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç `process_payment_flow`)
- **`/v1/initiate-payment`** ‚Äî –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **`/v1/yook-pay-webhook`** ‚Äî webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- **`/v1/order-status-page`** ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (HTML)
- **`/v1/order-status/<order_id>`** ‚Äî API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (JSON, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è polling)

### –ê–ª–∏–∞—Å—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ QR-–∫–æ–¥–∞–º–∏ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∞–ª–∏–∞—Å—ã:

- **`/v1/tbank-pay`** ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `process_payment_flow` (legacy alias)
- **`/v1/yook-pay`** ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `process_payment_flow` (legacy alias)

–í—Å–µ –∞–ª–∏–∞—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–µ–π `process_payment_flow()`, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã:

```bash
TMETR_TOKEN=<JWT —Ç–æ–∫–µ–Ω –¥–ª—è Tmetr API>
TMETR_HOST=<—Ö–æ—Å—Ç API Tmetr (–Ω–∞–ø—Ä–∏–º–µ—Ä, test.telemetry.fwsoft.ru)>
SECRET_KEY=<Django —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á>
DEBUG=<True/False>
DATABASE_URL=<–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL>
ORDER_EXPIRATION_MINUTES=<–≤—Ä–µ–º—è –ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15)>
DEVICE_ONLINE_THRESHOLD_MINUTES=<–ø–æ—Ä–æ–≥ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15)>
```

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
```bash
docker-compose up -d
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
docker-compose logs -f
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
docker-compose down
```
