# Requirements Document

## Introduction

This feature addresses the incompatibility between the current Order model's UUID primary key field and the actual order IDs generated by coffee machines. Coffee machines generate order IDs in a custom format (e.g., `20250317110122659ba6d7-9ace-cndn`) that is not valid UUID format. The system must accept and use these machine-generated IDs as the primary identifier for orders.

## Glossary

- **Order System**: The Django-based payment processing system that manages coffee orders
- **Coffee Machine**: Physical IoT device that generates QR codes with order information
- **Machine-Generated ID**: Custom format order identifier created by the coffee machine (e.g., `20250317110122659ba6d7-9ace-cndn`)
- **UUID Field**: Django's UUIDField that only accepts RFC 4122 compliant UUID format
- **Primary Key**: The unique identifier field used as the main reference for database records
- **QR Code URL**: The URL embedded in QR codes scanned by customers, containing order parameters including the machine-generated ID

## Requirements

### Requirement 1

**User Story:** As a coffee machine, I want to generate order IDs in my own format, so that I can track orders using my internal numbering system

#### Acceptance Criteria

1. WHEN THE Coffee Machine generates an order ID, THE Order System SHALL accept order IDs of any string format up to 255 characters
2. THE Order System SHALL use the machine-generated ID as the primary key for Order records
3. THE Order System SHALL maintain backward compatibility with existing UUID-based order references in related models
4. THE Order System SHALL validate that machine-generated IDs are non-empty strings before creating orders

### Requirement 2

**User Story:** As a system administrator, I want to migrate existing orders to the new ID format, so that the database remains consistent after the schema change

#### Acceptance Criteria

1. THE Order System SHALL preserve all existing order data during the migration process
2. THE Order System SHALL maintain referential integrity between Order records and related Payment, Receipt, and TBankPayment records
3. WHEN migrating existing orders, THE Order System SHALL convert UUID primary keys to string format without data loss
4. THE Order System SHALL complete the migration without requiring manual intervention

### Requirement 3

**User Story:** As a developer, I want the validation service to work with string-based order IDs, so that order existence checks function correctly

#### Acceptance Criteria

1. WHEN checking order existence, THE Order System SHALL query orders using string-based IDs from QR code parameters
2. THE Order System SHALL correctly identify duplicate orders based on machine-generated IDs
3. THE Order System SHALL validate order expiration using the new ID format
4. THE Order System SHALL log order validation operations with the machine-generated ID format

### Requirement 4

**User Story:** As a payment processor, I want to link payments to orders using machine-generated IDs, so that payment webhooks can update the correct orders

#### Acceptance Criteria

1. WHEN creating a payment, THE Order System SHALL reference orders using machine-generated IDs
2. WHEN receiving payment webhooks, THE Order System SHALL locate orders by machine-generated ID
3. THE Order System SHALL maintain the external_order_id field for additional tracking if needed
4. THE Order System SHALL update order status correctly regardless of ID format

### Requirement 5

**User Story:** As a QA engineer, I want comprehensive tests for the new ID format, so that I can verify the system works correctly with machine-generated IDs

#### Acceptance Criteria

1. THE Order System SHALL include unit tests validating order creation with non-UUID string IDs
2. THE Order System SHALL include integration tests verifying the complete payment flow with machine-generated IDs
3. THE Order System SHALL include tests confirming validation service compatibility with string IDs
4. THE Order System SHALL include tests verifying migration from UUID to string-based IDs
