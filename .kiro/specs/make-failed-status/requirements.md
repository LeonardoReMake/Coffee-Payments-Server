# Requirements Document

## Introduction

Данная фича добавляет новый статус заказа `make_failed` в систему обработки платежей кофейных автоматов. Статус используется для обработки ситуаций, когда команда на приготовление напитка не может быть отправлена на кофемашину из-за технических проблем с API Tmetr. Это позволяет системе корректно отслеживать заказы, которые были оплачены, но не могут быть выполнены из-за проблем с оборудованием.

## Glossary

- **Order System** — система обработки заказов кофейных напитков
- **Tmetr Service** — сервис интеграции с API Tmetr для управления кофемашинами
- **Payment Webhook** — обработчик уведомлений от платежных систем о статусе оплаты
- **Order Status Page** — веб-страница отслеживания статуса заказа пользователем
- **make_failed** — новый статус заказа, указывающий на ошибку при отправке команды приготовления

## Requirements

### Requirement 1

**User Story:** Как пользователь системы, я хочу видеть понятное сообщение об ошибке, когда мой оплаченный заказ не может быть выполнен из-за проблем с кофемашиной, чтобы понимать, что произошло и что делать дальше.

#### Acceptance Criteria

1. WHEN команда приготовления напитка через Tmetr API завершается ошибкой, THE Order System SHALL установить статус заказа в `make_failed`
2. WHEN статус заказа установлен в `make_failed`, THE Order Status Page SHALL отобразить пользователю сообщение об ошибке приготовления
3. WHEN статус заказа установлен в `make_failed`, THE Order Status Page SHALL остановить polling обновлений статуса
4. THE Order System SHALL логировать детали ошибки при установке статуса `make_failed` для технической диагностики

### Requirement 2

**User Story:** Как разработчик системы, я хочу, чтобы статус `make_failed` был интегрирован во все компоненты системы, чтобы обеспечить корректную обработку ошибок на всех уровнях.

#### Acceptance Criteria

1. THE Order System SHALL добавить `make_failed` в список допустимых статусов модели Order
2. THE Order System SHALL добавить описание статуса `make_failed` в централизованное хранилище пользовательских сообщений
3. THE Order Status Page SHALL отображать статус `make_failed` с соответствующей иконкой ошибки
4. THE Order System SHALL поддерживать статус-специфичную информацию для клиентов через поле `client_info_make_failed` модели Device

### Requirement 3

**User Story:** Как администратор системы, я хочу настраивать информацию, отображаемую пользователям при статусе `make_failed`, чтобы предоставлять контактные данные поддержки и инструкции по возврату средств.

#### Acceptance Criteria

1. THE Order System SHALL добавить поле `client_info_make_failed` в модель Device для хранения статус-специфичной информации
2. THE Device model SHALL поддерживать HTML-форматирование в поле `client_info_make_failed` для ссылок и форматированного текста
3. THE Order Status Page SHALL отображать содержимое поля `client_info_make_failed` при статусе заказа `make_failed`
4. WHEN поле `client_info_make_failed` не заполнено, THE Order Status Page SHALL отображать только стандартное сообщение об ошибке

### Requirement 4

**User Story:** Как оператор платежной системы, я хочу, чтобы ошибки при отправке команды приготовления обрабатывались корректно в webhook обработчике, чтобы не терять информацию об оплаченных заказах.

#### Acceptance Criteria

1. WHEN Payment Webhook получает уведомление об успешной оплате, THE Order System SHALL попытаться отправить команду приготовления через Tmetr Service
2. IF отправка команды приготовления завершается исключением, THEN THE Order System SHALL установить статус заказа в `make_failed`
3. IF отправка команды приготовления завершается исключением, THEN THE Order System SHALL логировать полную информацию об ошибке включая device_id и order_id
4. THE Order System SHALL продолжить обработку webhook после установки статуса `make_failed` без прерывания процесса
